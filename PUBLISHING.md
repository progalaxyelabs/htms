# Publishing Guide

This document explains how to publish the HTMS packages to npm and VSCode Marketplace.

## Package Structure

The monorepo contains three publishable packages:

1. **@htms/compiler** (WASM) - The core Rust compiler
2. **@htms/cli** - CLI tools and Vite plugin
3. **htms-vscode** - VSCode extension

## Prerequisites

```bash
# Install Rust and wasm-pack
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
cargo install wasm-pack

# Install Node.js 18+
# Install vsce for VSCode publishing
npm install -g @vscode/vsce
```

## Publishing Workflow

### 1. Publish the Compiler (WASM)

The compiler must be published first as other packages depend on it.

```bash
cd htms-compiler

# Build the WASM package
npm run build
# or: wasm-pack build --target nodejs --out-dir pkg

# The pkg/ folder now contains the npm package
cd pkg

# First time: login to npm
npm login

# Publish to npm
npm publish --access public

# Returns to htms-compiler/
cd ..
```

This publishes `@htms/compiler@0.1.0` to npm.

### 2. Publish the CLI

```bash
cd htms-compiler/cli

# Install dependencies (will now pull @htms/compiler from npm)
npm install

# Test the CLI works
node bin/htms.js --help

# Publish
npm publish --access public
```

This publishes `@htms/cli@0.1.0` to npm.

### 3. Publish the VSCode Extension

```bash
cd ../../htms-vscode

# Install dependencies
npm install

# Compile TypeScript
npm run compile

# Package the extension
npm run package

# Test the .vsix locally
code --install-extension htms-vscode-0.1.0.vsix

# Publish to VSCode Marketplace
vsce publish

# Or manually upload the .vsix to:
# https://marketplace.visualstudio.com/manage
```

## Version Bumping

When releasing a new version:

1. Update version in `Cargo.toml`
2. Update version in `htms-compiler/cli/package.json`
3. Update version in `htms-vscode/package.json`
4. Follow the publishing workflow above

## Local Development

For local development, you can use `file:` links:

```json
// htms-compiler/cli/package.json
{
  "dependencies": {
    "@htms/compiler": "file:../pkg"
  }
}
```

But before publishing, change to version ranges:

```json
{
  "dependencies": {
    "@htms/compiler": "^0.1.0"
  }
}
```

## Testing Before Publishing

### Test the Compiler

```bash
cd htms-compiler
cargo test
wasm-pack build --target nodejs
node -e "const c = require('./pkg'); console.log(c.compile('component A {}'))"
```

### Test the CLI

```bash
cd cli
npm install
node bin/htms.js compile ../examples/test.htms -o /tmp/output
```

### Test the VSCode Extension

```bash
cd ../htms-vscode
npm install
npm run compile
# Press F5 in VSCode to launch Extension Development Host
```

## CI/CD

Consider setting up GitHub Actions to automate publishing:

```yaml
# .github/workflows/publish.yml
name: Publish Packages

on:
  push:
    tags:
      - 'v*'

jobs:
  publish-compiler:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - run: cargo install wasm-pack
      - run: cd htms-compiler && wasm-pack build --target nodejs
      - run: cd htms-compiler/pkg && npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-cli:
    needs: publish-compiler
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: cd htms-compiler/cli && npm install && npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-vscode:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: cd htms-vscode && npm install && npm run package
      - run: npx vsce publish
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
```

## Package URLs

After publishing, packages will be available at:

- **Compiler**: https://www.npmjs.com/package/@htms/compiler
- **CLI**: https://www.npmjs.com/package/@htms/cli
- **VSCode**: https://marketplace.visualstudio.com/items?itemName=progalaxy-labs.htms-vscode

## Notes

- The `@htms/compiler` package is automatically generated by wasm-pack
- Make sure to use `--access public` for scoped packages
- VSCode Marketplace requires a publisher account at https://marketplace.visualstudio.com/manage
